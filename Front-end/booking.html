<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking-html</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Gupter:wght@400;500;700&family=Lora:ital,wght@0,400..700;1,400..700&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Oswald:wght@200..700&family=Quicksand:wght@300..700&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Rubik:ital,wght@0,300..900;1,300..900&family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

</head>
<body>
    <div class="header">
        <div><img src="Images/logo.png" alt="Startlight Cinema"></div>
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search Movies..." class="search-input">
        </div>
        <div><img src="Images/logo.png" alt="Startlight Cinema"></div>
    </div>

    <div class="seat-body">
        <div class="cinema-background-area">
            <h1 style="color: orange;">Select Your Seats</h1>
            <div class="seats-grid">
                <!-- Row A -->
                <button class="seat" id="seatA1">A1</button>
                <button class="seat" id="seatA2">A2</button>
                <button class="seat" id="seatA3">A3</button>
                <button class="seat" id="seatA4">A4</button>
                <button class="seat" id="seatA5">A5</button>
                <button class="seat" id="seatA6">A6</button>
                <button class="seat" id="seatA7">A7</button>
                <button class="seat" id="seatA8">A8</button>
                <button class="seat" id="seatA9">A9</button>
                <button class="seat" id="seatA10">A10</button>
                
                <!-- Row B -->
                <button class="seat" id="seatB1">B1</button>
                <button class="seat" id="seatB2">B2</button>
                <button class="seat" id="seatB3">B3</button>
                <button class="seat" id="seatB4">B4</button>
                <button class="seat" id="seatB5">B5</button>
                <button class="seat" id="seatB6">B6</button>
                <button class="seat" id="seatB7">B7</button>
                <button class="seat" id="seatB8">B8</button>
                <button class="seat" id="seatB9">B9</button>
                <button class="seat" id="seatB10">B10</button>
                
                <!-- Row C -->
                <button class="seat" id="seatC1">C1</button>
                <button class="seat" id="seatC2">C2</button>
                <button class="seat" id="seatC3">C3</button>
                <button class="seat" id="seatC4">C4</button>
                <button class="seat" id="seatC5">C5</button>
                <button class="seat" id="seatC6">C6</button>
                <button class="seat" id="seatC7">C7</button>
                <button class="seat" id="seatC8">C8</button>
                <button class="seat" id="seatC9">C9</button>
                <button class="seat" id="seatC10">C10</button>
                
                <!-- Row D -->
                <button class="seat" id="seatD1">D1</button>
                <button class="seat" id="seatD2">D2</button>
                <button class="seat" id="seatD3">D3</button>
                <button class="seat" id="seatD4">D4</button>
                <button class="seat" id="seatD5">D5</button>
                <button class="seat" id="seatD6">D6</button>
                <button class="seat" id="seatD7">D7</button>
                <button class="seat" id="seatD8">D8</button>
                <button class="seat" id="seatD9">D9</button>
                <button class="seat" id="seatD10">D10</button>
                
                <!-- Row E -->
                <button class="seat" id="seatE1">E1</button>
                <button class="seat" id="seatE2">E2</button>
                <button class="seat" id="seatE3">E3</button>
                <button class="seat" id="seatE4">E4</button>
                <button class="seat" id="seatE5">E5</button>
                <button class="seat" id="seatE6">E6</button>
                <button class="seat" id="seatE7">E7</button>
                <button class="seat" id="seatE8">E8</button>
                <button class="seat" id="seatE9">E9</button>
                <button class="seat" id="seatE10">E10</button>
                
                <!-- Row F -->
                <button class="seat" id="seatF1">F1</button>
                <button class="seat" id="seatF2">F2</button>
                <button class="seat" id="seatF3">F3</button>
                <button class="seat" id="seatF4">F4</button>
                <button class="seat" id="seatF5">F5</button>
                <button class="seat" id="seatF6">F6</button>
                <button class="seat" id="seatF7">F7</button>
                <button class="seat" id="seatF8">F8</button>
                <button class="seat" id="seatF9">F9</button>
                <button class="seat" id="seatF10">F10</button>
                
                <!-- Row G -->
                <button class="seat" id="seatG1">G1</button>
                <button class="seat" id="seatG2">G2</button>
                <button class="seat" id="seatG3">G3</button>
                <button class="seat" id="seatG4">G4</button>
                <button class="seat" id="seatG5">G5</button>
                <button class="seat" id="seatG6">G6</button>
                <button class="seat" id="seatG7">G7</button>
                <button class="seat" id="seatG8">G8</button>
                <button class="seat" id="seatG9">G9</button>
                <button class="seat" id="seatG10">G10</button>
                
                <!-- Row H -->
                <button class="seat" id="seatH1">H1</button>
                <button class="seat" id="seatH2">H2</button>
                <button class="seat" id="seatH3">H3</button>
                <button class="seat" id="seatH4">H4</button>
                <button class="seat" id="seatH5">H5</button>
                <button class="seat" id="seatH6">H6</button>
                <button class="seat" id="seatH7">H7</button>
                <button class="seat" id="seatH8">H8</button>
                <button class="seat" id="seatH9">H9</button>
                <button class="seat" id="seatH10">H10</button>
                
                <!-- Row I -->
                <button class="seat" id="seatI1">I1</button>
                <button class="seat" id="seatI2">I2</button>
                <button class="seat" id="seatI3">I3</button>
                <button class="seat" id="seatI4">I4</button>
                <button class="seat" id="seatI5">I5</button>
                <button class="seat" id="seatI6">I6</button>
                <button class="seat" id="seatI7">I7</button>
                <button class="seat" id="seatI8">I8</button>
                <button class="seat" id="seatI9">I9</button>
                <button class="seat" id="seatI10">I10</button>
                
                <!-- Row J -->
                <button class="seat" id="seatJ1">J1</button>
                <button class="seat" id="seatJ2">J2</button>
                <button class="seat" id="seatJ3">J3</button>
                <button class="seat" id="seatJ4">J4</button>
                <button class="seat" id="seatJ5">J5</button>
                <button class="seat" id="seatJ6">J6</button>
                <button class="seat" id="seatJ7">J7</button>
                <button class="seat" id="seatJ8">J8</button>
                <button class="seat" id="seatJ9">J9</button>
                <button class="seat" id="seatJ10">J10</button>
            </div>
        </div>
    
        <div class="payment-details">
            <h1 style="color: orange;">Payment Details</h1>
            <form id="paymentForm">
                <label for="userId">User ID No:</label>
                <input type="text" id="userId" name="userId" required>
    
                <label for="cardNumber">Card Number:</label>
                <input type="text" id="cardNumber" name="cardNumber" required>

                <label for="expiryYear">Expiry:</label>
                <input type="text" id="expiryYear" name="expiryYear" placeholder="MM/YY" required>
    
                <div style="height: 110px;">
                    <p>Ticket price : LKR. <span id="ticket-price"></span>.00</p>
                    <p>Booking Fee : LKR. <span id="booking-fee"></span>.00</p>
                    <p>Total Fee : LKR.<span id="total-fee"></span>.00</p>
                </div>
    
                <button type="submit">Submit Payment</button>
            </form>
        </div>
    </div>


    <div class="footer">
        <div class="footer-container">
            <div class="item1 item">
                <h3>GENERAL</h3>
                <a href="">About Us</a> | <a href="">FAQ'S</a> | <a href="">Feedback</a> | <br>
                <a href="">Privancy Policy</a> | <a href="">Terms & Conditions</a> | <br>
            </div>
            <div class="itme2 item">
                <h3>POPULAR MOVIES BY LANGUAGE</h3>
                <a href="">Latest Sinhala Movies</a> <br>
                <a href="">Latest English Movies</a> <br>
                <a href="">Latest Hindi Movies</a> <br>
                <a href="">Latest Tamil Movies</a> <br>
            </div>
            <div class="item3 item">
                <h3>MOVIES BY GENRE</h3>
                <a href="">Best Action Movies</a> | <a href="">Best Romantic Movies</a> | <br>
                <a href="">Best Comedy Movies</a> | <a href="">Best Adventure Movies</a> | <br>
                <a href="">Best Biography Movies</a> | <a href="">Best Crime Movies</a> | <br>
                <a href="">Best Drama Movies</a> | <a href="">Best Family Movies</a> | <br>
                <a href="">Best Fantasy Movies</a> | <a href="">Best History Movies</a> | <br>
                <a href="">Best Musical Movies</a> | <a href="">Best Mystery Movies</a> | <br>
                <a href="">Best Thriller Movies</a> <br>
            </div>
            <div class="item4 item">
                <h3>SOCIAL MEDIA</h3>
                <div class="image-sm">
                    <a href=""><img id="instagram" src="Images/instagram.png" alt=""></a>
                    <a href=""><img src="Images/whatsapp.png" alt=""></a>
                    <a href=""><img src="Images/youtube.png" alt=""></a>
                </div>
                <div class="image-sm">
                    <a href=""><img src="Images/linkedin.png" alt=""></a>
                    <a href=""><img src="Images/github.png" alt=""></a>
                    <a href=""><img src="Images/twitter.png" alt=""></a>
                </div>
            </div>
        </div>
        <div class="credits">
            <hr>
            Copyright © 2024 A.Dasun Navindu Dewnith Nandasiri All Rights Reserved. <br>
            The content and images used on this site are copyright protected and copyrights vests with the respective
            owners. The
            usage of the content and images on this website is intended to promote the works and no endorsement of the
            artist shall <br>
            be implied. Unauthorized use is prohibited and punishable by law. <br>
        </div>
    </div>

    <script>
        let urlParams = new URLSearchParams(window.location.search);
        let title = urlParams.get('title');
        let timeSlot = urlParams.get('timeSlot');
        let movieDate = urlParams.get('movieDate');
        let numOfSeats = parseInt(urlParams.get('numSeats'), 10);
        let bookingId;
        let selectedSeats = [];
        let totalFee;

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('ticket-price').innerHTML = numOfSeats * 500;
            document.getElementById('booking-fee').innerHTML = 140;
            totalFee = (numOfSeats * 500) + 140;
            document.getElementById('total-fee').innerHTML = totalFee;
            
            const prefix = "STC";
            let currentNumber = localStorage.getItem('currentBookingId') || 1; 
            bookingId = prefix + String(currentNumber).padStart(6, '0'); 

            localStorage.setItem('currentBookingId', Number(currentNumber) + 1); 

            const apiEndpoint = `http://localhost:8080/api/bookingSeat/seat/${movieDate}/${timeSlot}`;

            fetch(apiEndpoint)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(seatNos => {
                    console.log("Retrieved seat numbers:", seatNos);

                    seatNos.forEach(seatNo => {
                        const seatButton = document.getElementById(`${seatNo}`);
                        if (seatButton) {
                            seatButton.style.backgroundColor = '#996633';  
                            seatButton.disabled = true;  
                        }
                    });

                })
                .catch(error => {
                    console.error("Error fetching seat numbers:", error);
                });

                
            const seatButtons = document.querySelectorAll('.seat');
            seatButtons.forEach(seatButton => {
                seatButton.addEventListener('click', function () {
                    if (this.disabled) return;

                    if (this.style.backgroundColor === '#27190c') {
                        this.style.backgroundColor = ''; 
                        const index = selectedSeats.indexOf(this.id);
                        if (index > -1) {
                            selectedSeats.splice(index, 1); 
                        }
                    } else {
                        if (selectedSeats.length < numOfSeats) {
                            this.style.backgroundColor = '#27190c'; 
                            selectedSeats.push(this.id); 
                        } else {
                            alert(`You can only select ${numOfSeats} seats.`);
                        }
                    }
                });
                console.log(selectedSeats); 
            });

            const paymentForm = document.getElementById('paymentForm');
            paymentForm.addEventListener('submit', function (event) {
                event.preventDefault(); 

                if (selectedSeats.length !== numOfSeats) {
                    alert(`You select exactly ${selectedSeats.length} seats.`);
                    return;
                }

                const formData = new FormData(paymentForm);
                const paymentData = {
                    bookingId: bookingId,
                    cardNo: formData.get('cardNumber'),
                    movieDate: movieDate,
                    numOfSeats: String(numOfSeats),
                    timeSlot: timeSlot,
                    title: title,
                    userId: formData.get('userId')
                };

                fetch('http://localhost:8080/api/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error submitting payment data');
                        }
                        return response.json();
                    })
                    .then(paymentResponse => {
                        console.log('Payment Data Submitted:', paymentResponse);

                        const bookingData = selectedSeats.map(seatNo => ({
                            bookingId: bookingId,
                            movieDate: movieDate,
                            seatNo: seatNo,
                            timeSlot: timeSlot
                        }));

                        return fetch('http://localhost:8080/api/bookingSeat/all', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(bookingData)
                        });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error submitting seat booking data');
                        }
                        return response.json();
                    })
                    .then(bookingResponse => {
                        console.log('Seat Booking Data Submitted:', bookingResponse);
                        alert('Booking Successfully!');

                        const queryParams = new URLSearchParams({
                            title: title,
                            timeSlot: timeSlot,
                            movieDate: movieDate,
                            numOfSeats: numOfSeats,
                            bookingId: bookingId,
                            totalFee: totalFee
                        }).toString();

                        window.location.replace(`ticket-pdf.html?${queryParams}`);
                    })
                    .catch(error => {
                        alert('Error during booking submission');
                        console.error('Error:', error);
                    });
            });

        });

        

    </script>
</body>
</html>