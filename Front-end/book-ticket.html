<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Ticket</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Gupter:wght@400;500;700&family=Lora:ital,wght@0,400..700;1,400..700&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Oswald:wght@200..700&family=Quicksand:wght@300..700&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Rubik:ital,wght@0,300..900;1,300..900&family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
</head>
<body>
    <div class="header">
        <div><img src="Images/logo.png" alt="Startlight Cinema"></div>
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search Movies..." class="search-input">
        </div>
        <div><img src="Images/logo.png" alt="Startlight Cinema"></div>
    </div>

    <h1 style="text-align: center; color: orange; font-family: 'Poppins', sans-serif;">Booking Details</h1>
    
    <div class="book-ticket-container">
        <div class="movie-details">
            <img id="movieThumbnail" alt="Movie Thumbnail">
            <h2 id="movieTitle"></h2>
            <p id="movieCategory"></p>
            <p id="movieLanguage"></p>
        </div>

        <div class="booking-details">
            <p>Date Range:</p>
            <p id="dateRange"></p>
        
            <label for="dateSelector">Select Date:</label><br>
            <select id="dateSelector" required>
                
            </select>
        
            <div>
                <br>
                <label for="timeSlotsContainer">Time Slots:</label>
                <div class="timeSlotsContainer" id="timeSlotsContainer">

                </div>
            </div>
            <br>
            <label for="numSeats">Number of Seats (2-10):</label>
            <input type="number" id="numSeats" name="numSeats" min="2" max="10" required><br><br>
        
            <button id="bookTicketButton">Book Ticket</button>
        </div>
    </div>

    <div class="footer">
        <div class="footer-container">
            <div class="item1 item">
                <h3>GENERAL</h3>
                <a href="">About Us</a> | <a href="">FAQ'S</a> | <a href="">Feedback</a> | <br>
                <a href="">Privancy Policy</a> | <a href="">Terms & Conditions</a> | <br>
            </div>
            <div class="itme2 item">
                <h3>POPULAR MOVIES BY LANGUAGE</h3>
                <a href="">Latest Sinhala Movies</a> <br>
                <a href="">Latest English Movies</a> <br>
                <a href="">Latest Hindi Movies</a> <br>
                <a href="">Latest Tamil Movies</a> <br>
            </div>
            <div class="item3 item">
                <h3>MOVIES BY GENRE</h3>
                <a href="">Best Action Movies</a> | <a href="">Best Romantic Movies</a> | <br>
                <a href="">Best Comedy Movies</a> | <a href="">Best Adventure Movies</a> | <br>
                <a href="">Best Biography Movies</a> | <a href="">Best Crime Movies</a> | <br>
                <a href="">Best Drama Movies</a> | <a href="">Best Family Movies</a> | <br>
                <a href="">Best Fantasy Movies</a> | <a href="">Best History Movies</a> | <br>
                <a href="">Best Musical Movies</a> | <a href="">Best Mystery Movies</a> | <br>
                <a href="">Best Thriller Movies</a> <br>
            </div>
            <div class="item4 item">
                <h3>SOCIAL MEDIA</h3>
                <div class="image-sm">
                    <a href=""><img id="instagram" src="Images/instagram.png" alt=""></a>
                    <a href=""><img src="Images/whatsapp.png" alt=""></a>
                    <a href=""><img src="Images/youtube.png" alt=""></a>
                </div>
                <div class="image-sm">
                    <a href=""><img src="Images/linkedin.png" alt=""></a>
                    <a href=""><img src="Images/github.png" alt=""></a>
                    <a href=""><img src="Images/twitter.png" alt=""></a>
                </div>
            </div>
        </div>
        <div class="credits">
            <hr>
            Copyright Â© 2024 A.Dasun Navindu Dewnith Nandasiri All Rights Reserved. <br>
            The content and images used on this site are copyright protected and copyrights vests with the respective
            owners. The
            usage of the content and images on this website is intended to promote the works and no endorsement of the
            artist shall <br>
            be implied. Unauthorized use is prohibited and punishable by law. <br>
        </div>
    </div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const movieTitle = urlParams.get('title');
        const movieCategory = urlParams.get('category');
        const movieLanguage = urlParams.get('language');
        const movieThumbnail = urlParams.get('thumbnail');
        let timeSlot;

        document.getElementById('movieTitle').innerText = movieTitle ? `Title: ${movieTitle}` : "Movie Title";
        document.getElementById('movieCategory').innerText = movieCategory ? `Category: ${movieCategory}` : "Category";
        document.getElementById('movieLanguage').innerText = movieLanguage ? `Language: ${movieLanguage}` : "Language";
        document.getElementById('movieThumbnail').src = movieThumbnail || "default-thumbnail.jpg";
    
        
        document.addEventListener('DOMContentLoaded', function () {
            const movieTitle = urlParams.get('title');

            fetch(`http://localhost:8080/api/booking/${movieTitle}`)
                .then(response => {
                    if (!response.ok) {
                        console.error(`HTTP error! status: ${response.status}`);
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.start_date && data.end_date) {
                        const startDate = new Date(data.start_date);
                        const endDate = new Date(data.end_date);

                        const dateRangeText = `${data.start_date} to ${data.end_date}`;
                        document.getElementById('dateRange').textContent = dateRangeText;

                        populateDateSelector(startDate, endDate);
                    } else {
                        document.getElementById('dateRange').textContent = 'Date range not available.';
                    }
                })
                .catch(error => {
                    console.error('Error fetching booking details:', error);
                    document.getElementById('dateRange').textContent = 'Error fetching date range: ' + error.message;
                });

            populateTimeSlot(movieTitle);

        });

        function populateDateSelector(startDate, endDate) {
            const dateSelector = document.getElementById('dateSelector');

            dateSelector.innerHTML = '';

            for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate() + 1)) {
                const option = document.createElement('option');
                const formattedDate = dt.toISOString().split('T')[0]; 
                option.value = formattedDate; 
                option.textContent = formattedDate; 
                dateSelector.appendChild(option); 
            }
        }

        function populateTimeSlot(movieTitle) {
            return fetch(`http://localhost:8080/api/booking/timeSlots/${encodeURIComponent(movieTitle)}`)
                .then(response => {
                    if (!response.ok) {
                        console.error(`HTTP error! Status: ${response.status}`);
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched data:', data); 

                    if (!data || (typeof data !== 'string' && !Array.isArray(data))) {
                        throw new Error('No time slot available for this movie.');
                    }

                    timeSlot = Array.isArray(data) ? data[0] : data; 

                    const timeSlotsContainer = document.querySelector('.timeSlotsContainer');
                    timeSlotsContainer.innerHTML = `<div>${timeSlot}</div>`;

                    return timeSlot; 
                })
                .catch(error => {
                    console.error('Error fetching time slot:', error);
                    alert('Error fetching time slot: ' + error.message);
                });
        }

        document.getElementById('bookTicketButton').addEventListener('click', function () {
            const title = document.getElementById('movieTitle').innerText.replace("Title: ", ""); 
            const movieDate = document.getElementById('dateSelector').value; 
            const numSeats = document.getElementById('numSeats').value; 

            if (!title || !movieDate || !numSeats) {
                alert('Please fill in all fields.');
                return;
            }

            const ticketData = {
                title: title,
                movie_date: movieDate,
                time_slot: timeSlot,
                num_of_sets: numSeats
            };

            fetch('http://localhost:8080/api/tickets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(ticketData),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to save ticket');
                    }
                    return response.json();
                })
                .then(data => {
                    const ticketId = data.id;
                    window.location.replace(`booking.html?title=${encodeURIComponent(title)}&movieDate=${encodeURIComponent(movieDate)}&numSeats=${encodeURIComponent(numSeats) }&timeSlot=${encodeURIComponent(timeSlot) }`);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error booking ticket: ' + error.message);
                });
        });
    </script>
    
</body>
</html>